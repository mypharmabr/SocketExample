<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Orders Receiver</title>
</head>
<body>
<form>
    <input name='email' id='email-input' type='email' placeholder='email' />
    <input name='password' id='password-input' type='password' placeholder='password'>
    <button id='login-btn' type='submit'>Login</button>
</form>
<p id='logged-label'>Please login</p>
<button id='start-btn'>Start Listening</button>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" type='text/javascript'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.slim.js" type='text/javascript'></script>
<script type="text/javascript">
  // Constants (change by the correct values)
  const API_URL = 'http://localhost:8000'
  const SOCKET_URL = 'http://localhost:8890'

  // Declare vars
  let emailInput
  let passwordInput
  let loginBtn
  let startBtn
  let label
  let isLoggedIn = false
  let loggedToken
  let socket

  // Init buttons and inputs
  $(document).ready(function () {
    emailInput = $('#email-input')
    passwordInput = $('#password-input')
    loginBtn = $('#login-btn')
    startBtn = $('#start-btn')
    label = $('#logged-label')

    loginBtn.click(function (e) {
      e.preventDefault()
      const email = emailInput.val()
      const password = passwordInput.val()
      login(email, password)
    })

    startBtn.click(function () {
      if (isLoggedIn) {
        listen()
      } else {
        alert('Log in before you start listening!')
      }
    })
  })

  // Call login api and store the token
  function login (email, password) {
    $.ajax({
      type: 'POST',
      url: API_URL + '/v2/login',
      data: {
        email: email,
        password: password
      },
      success: function (data) {
        console.log(data)
        isLoggedIn = true
        loggedToken = data.access_token
        label.text('Welcome ' + data.user.name)
      },
      error: function (data) {
        isLoggedIn = false
        loggedToken = ''
        alert(data.responseJSON.error)
      }
    })
  }

  function listen () {
    socket = io(SOCKET_URL)
    socket.on('connect', connected)
    socket.on('disconnect', disconnected)
  }

  function connected () {
    socket.emit('subscribe', {
      channel: 'private-drugstore.orders.2'
    })
    socket.on('order.created', eventReceived)
    label.text('Listening...')
  }

  function disconnected () {
    label.text('Disconnected. Attempting again in 5 seconds...')
    setTimeout(listen, 5000)
  }

  function eventReceived (channel, data) {
    console.log(data)
    // window.io = require('socket.io-client')
    // window.echo = new Echo({
    //   broadcaster: 'socket.io',
    //   host: 'http://localhost:8890',
    //   namespace: 'MyPharmaWebservices.Events'
    // })
    // echo
    //   .private('drugstore.orders.' + 2)
    //   .listen('.order.created', (e) => {
    //     console.log(e)
    //   })
  }
</script>
</body>
</html>
